<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
		<style type="text/css">
			body,
			html {
				width: 100%;
				height: 100%;
				overflow: hidden;
				margin: 0;
				font-family: "微软雅黑";
			}

			#allmap {
				position: absolute;
				left: 0px;
				width: 100%;
				height: 100%;
				overflow: hidden;
				margin: 0;
				font-family: "微软雅黑";
			}
		</style>
		<script type="text/javascript" src="https://api.map.baidu.com/api?v=2.0&ak=Cg6GIDFs6h0NAan5CA5GxIDScopVviOg"></script>
		<script type="text/javascript" src="../../js/Url.js"></script>
		<script type="text/javascript" src="../../js/jquery.min.js"></script>
		<title>订单轨迹展示</title>
	</head>
	<body>
		<div id="allmap"></div>
		<script type="text/javascript">
			var url1=window.globalConfig.api;//接口地址
			var id = localStorage.getItem("userid");
			var token = localStorage.getItem("token");
			//获取当前url
			var url = window.location.href;
			GetRequest(url);
			//获取订单id
			function GetRequest(url) {
				// var url = location.search; //获取url中"?"符后的字串 
				var theRequest = {};
				if (url.indexOf("?") != -1) {
					var str = url.substring(url.indexOf("?") + 1);
					// var str = str.substr(1); 
					console.log(str);
					strs = str.split("&");
					console.log(strs);
					for (var i = 0; i < strs.length; i++) {
						theRequest[strs[i].split("=")[0]] = unescape(strs[i].split("=")[1]);
					}
				}
				//console.log(theRequest);
				var o_id = theRequest.o_id;
				console.log('o_id', o_id)
				//return theRequest;
                /* ajax*/
				$.ajax({
					url: url1+'/admin/Order/order_trajectory',
					type: "POST",
					data: {
						id: id,
						token:token,
						o_id:o_id
					},
					dataType: "json",
					success: function(data) {
						console.log('guiji', data)
						/* 轨迹展示开始 */
						var list = data;
						console.log('list', list)
						if(list==null){
							alert("里程太短,没有轨迹~");
							return false;
						}
						var listLast = list.length - 1;
						// 百度地图API功能
						var map = new BMap.Map("allmap"); // 创建Map实例
						map.centerAndZoom(new BMap.Point(list[0].Long, list[0].Lat), 16); // 初始化地图,设置中心点坐标和地图级别
						map.addControl(new BMap.MapTypeControl()); //添加地图类型控件
						map.enableScrollWheelZoom(true); //开启鼠标滚轮缩放
						
						setTimeout(drawIcon, 500);
						var carMk;
						var myBeginIcon = new BMap.Icon("../../images/str.png", new BMap.Size(28, 28), {
							imageOffset: new BMap.Size(0, 0)
						}); //起点
						var myEndIcon = new BMap.Icon("../../images/end.png", new BMap.Size(28, 28), {
							imageOffset: new BMap.Size(0, 0)
						}); //终点
						
						function drawGreenLine(i) {
							var polyline = new BMap.Polyline([
								new BMap.Point(list[i].Long, list[i].Lat), //起始点的经纬度
								new BMap.Point(list[i + 1].Long, list[i + 1].Lat) //终点的经纬度
							], {
								strokeColor: "green", //设置颜色
								strokeWeight: 4, //宽度
								strokeOpacity: 1
							}); //透明度
							map.addOverlay(polyline);
						}
						
						function drawIcon() {
							if (carMk) {
								map.removeOverlay(carMk);
							}
							carMk2 = new BMap.Marker(
								new BMap.Point(list[0].Long, list[0].Lat), //起始点的经纬度
								{
									icon: myBeginIcon
								});
							map.addOverlay(carMk2);
						
							carMk = new BMap.Marker(
								new BMap.Point(list[listLast].Long, list[listLast].Lat), //终点的经纬度
								{
									icon: myEndIcon
								});
							map.addOverlay(carMk);
						
							for (var i = 0; i < list.length - 1; i++) {
								drawGreenLine(i);
							}
						}
						/* 轨迹展示结束 */
					},
				})
				/*ajaxend*/
			}
		</script>
	</body>
</html>
