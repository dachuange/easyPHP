<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta content="yes" name="apple-mobile-web-app-capable">
		<meta content="black" name="apple-mobile-web-app-status-bar-style">
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta http-equiv="pragma" content="no-cache">
		<meta http-equiv="cache-control" content="no-cache">
		<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
		<meta http-equiv="Pragma" content="no-cache" />
		<meta http-equiv="Expires" content="0" />
		<link rel="stylesheet" href="__PUBLIC__/home/css/updatephone1.css" media="all">
		<title>修改手机号</title>
		<style>
			.disable {
				pointer-events: none;
			}
		</style>
		<script type="text/javascript" src="__PUBLIC__/home/js/jquery.min.js"></script>
		<link rel="stylesheet" href="__PUBLIC__/home/css/alert.css" media="all">
	<link rel="stylesheet" href="__PUBLIC__/home/css/login.css" media="all">

		<script type="text/javascript">
			function isPhone() {
				//弹框
				var toast = function(params) {
					var el = document.createElement("div");
					el.setAttribute("id", "toast");
					el.innerHTML = params.message;
					document.body.appendChild(el);
					el.classList.add("fadeIn");
					setTimeout(function() {
						el.classList.remove("fadeIn");
						el.classList.add("fadeOut");
						el.addEventListener("animationend", function() {
							el.classList.add("hide");
						});
					}, params.time);
				};
				var phone1 = $('#oldphone').val();
				var phone = $('#newphone').val();
				if (phone == "") {
					//alert("手机号不能为空");
					toast({
						message: "手机号不能为空",
						time: 1500
					});
					return false;
				}
				if (phone.length != 11) {
					toast({
						message: "手机号位数不正确",
						time: 1500
					});
					return false;
				}
				if (phone == phone1) {
					//alert("新手机号不能与旧手机号相同");
					toast({
						message: "新手机号不能与旧手机号相同",
						time: 1500
					});
					return false;
				}
				var myreg= /^[1](([3][0-9])|([4][5-9])|([5][0-3,5-9])|([6][5,6])|([7][0-8])|([8][0-9])|([9][1,8,9]))[0-9]{8}$/;
				if (!(myreg.test(phone))) {
					//alert("手机号码有误，请重填");
					toast({
						message: "手机号码有误，请重填",
						time: 1500
					});
					return false;
				}
			}

			//发送短信验证码
			function sendVerCode1() {
				// 禁用点击事件
				$("#sendVerCode").addClass("disable");
				// 提交业务
				//弹框
				var toast = function(params) {
					var el = document.createElement("div");
					el.setAttribute("id", "toast");
					el.innerHTML = params.message;
					document.body.appendChild(el);
					el.classList.add("fadeIn");
					setTimeout(function() {
						el.classList.remove("fadeIn");
						el.classList.add("fadeOut");
						el.addEventListener("animationend", function() {
							el.classList.add("hide");
						});
					}, params.time);
				};
				var phone1 = $('#oldphone').val();
				var phone = $('#newphone').val();
				if (phone == "") {
					$("#sendVerCode").removeClass("disable");
					toast({
						message: "手机号不能为空",
						time: 1500
					});
					return false;
				}
				if (phone.length != 11) {
					$("#sendVerCode").removeClass("disable");
					toast({
						message: "手机号位数不正确",
						time: 1500
					});
					return false;
				}
				if (phone == phone1) {
					$("#sendVerCode").removeClass("disable");
					toast({
						message: "新手机号不能与旧手机号相同",
						time: 1500
					});
					return false;
				}
				var myreg= /^[1](([3][0-9])|([4][5-9])|([5][0-3,5-9])|([6][5,6])|([7][0-8])|([8][0-9])|([9][1,8,9]))[0-9]{8}$/;
				if (!(myreg.test(phone))) {
					$("#sendVerCode").removeClass("disable");
					toast({
						message: "手机号码有误，请重填",
						time: 1500
					});
					return false;
				}
				$.ajax({
					//url:' http://39.98.43.249/User/token',//跨域调取URL
					url: '__APP__/User/token', //不跨域调取url
					type: 'post',
					//data:'id='+id,
					success: function(data) {
						console.log('data', data)
						var token = data.token;
						$('#token').val(token);
						//获取验证码
						if (phone != "") {
							$.ajax({
								url: '__APP__/User/getyzm',
								type: "POST",
								data: {
									token: token,
									phone: phone
								},
								dataType: "json",
								async: 'false',
								success: function(data) {
									var yzm = data.yzm;
									console.log('yzm', yzm);
									if (data.error_code == 0) {
										//倒计时
										let count = 60;
										const countDown = setInterval(() => {
											if (count === 0) {
												$("#sendVerCode").removeClass("disable");
												$('#sendVerCode').text('获取验证码').removeAttr('disabled');
												clearInterval(countDown);
											} else {
												$('#sendVerCode').attr('disabled', true);
												$('#sendVerCode').text('重新发送(' + count + ')');
											}
											count--;
										}, 1000);
										toast({
											message: "验证码已下发，请注意查收",
											time: 1500
										});
										return false;
									}
									if (data.error_code == 1) {
										$("#sendVerCode").removeClass("disable");
										toast({
											message: "号码无效",
											time: 1500
										});
										return false;
									} else if (data.error_code == 2) {
										$("#sendVerCode").removeClass("disable");
										toast({
											message: "该号码达到上限",
											time: 1500
										});
										return false;
									} else if (data.error_code == -501) {
										$("#sendVerCode").removeClass("disable");
										toast({
											message: data.code,
											time: 1500
										});
										return false;
									}
								}
							});
						}
					},
				})
			};
			//保存
			function save() {
				//弹框
				var toast = function(params) {
					var el = document.createElement("div");
					el.setAttribute("id", "toast");
					el.innerHTML = params.message;
					document.body.appendChild(el);
					el.classList.add("fadeIn");
					setTimeout(function() {
						el.classList.remove("fadeIn");
						el.classList.add("fadeOut");
						el.addEventListener("animationend", function() {
							el.classList.add("hide");
						});
					}, params.time);
				};
				var id = $('#id').val();
				var phone = $('#newphone').val();
				var token = $('#token').val();
				var phoneCode = $('#phoneCode').val();
				if (phone == "") {
					//alert("手机号不能为空");
					toast({
						message: "手机号不能为空",
						time: 1500
					});
					return false;
				}
				var myreg= /^[1](([3][0-9])|([4][5-9])|([5][0-3,5-9])|([6][5,6])|([7][0-8])|([8][0-9])|([9][1,8,9]))[0-9]{8}$/;
				if (!(myreg.test(phone))) {
					//alert("手机号码有误，请重填");
					toast({
						message: "手机号码有误，请重填",
						time: 1500
					});
					return false;
				}
				if (phoneCode == "") {
					toast({
						message: "验证码不能为空",
						time: 1500
					});
					return false;
				}
				$.ajax({
					url: '__APP__/User/upuser_phone_chk', //不跨域调取url
					type: 'post',
					data: {
						token: token,
						id: id,
						phone: phone,
						yzm: phoneCode
					},
					success: function(data) {
						console.log('data', data)
						var code = data.error_code;
						//alert(data.error_code)
						console.log('code', code);
						if (code == 0) {
							//alert("手机号修改成功")
							toast({
								message: "手机号修改成功",
								time: 1100
							});
							setTimeout(function() {
								window.location.href = "__APP__/User/usercenter"
							}, 1200);
						} else if (code == -401) {
							//alert("手机号已绑定")
							toast({
								message: data.message,
								time: 1500
							});
						} else if (code == -1011) {
							//alert("验证码不正确")
							toast({
								message: data.message,
								time: 1500
							});
						} else {
							//alert("手机号修改失败")
							toast({
								message: "手机号修改失败",
								time: 1500
							});
						}
					}
				});
			}
			//获取token
			function time() {
				$.ajax({
					//url:' http://39.98.43.249/User/token',//跨域调取URL
					url: '__APP__/User/token', //不跨域调取url
					type: 'post',
					//data:'id='+id,
					success: function(data) {
						console.log('data', data)
						var token = data.token;
						console.log('token', token)
						$('#token').val(token);
					}
				});
			}
			//每隔7200执行一次
			$(function() {
				//time();
				//setInterval(time, 7200);
			})
		</script>
	</head>

	<body>
		<div class="content">
			<form class="resetpassform" id="reset-form">
				<section class="aui-flexView">
					<section class="aui-scrollView">
							<div class="logo-area">
									<div class='logo'>
										<img src="__PUBLIC__/home/images/user-logo.png" alt="logo">
									</div>
									<div class='text'>e达出行</div>
			
								</div>
						<div class="aui-ver-form">
							<div class="aui-flex">
								<div class="aui-flex-box">
									<i class="icon icon-yaocode"></i>
									<input type="number" id="oldphone" value="{$user.phone}" maxlength="11" placeholder="旧手机号码" readonly="true">
								</div>
							</div>
							<div class="aui-flex">
								<div class="aui-flex-box">
									<i class="icon icon-yaocode"></i>
									<input type="tel" maxlength="11" id="newphone" placeholder="新手机号码" onblur="isPhone();">
								</div>
							</div>
							<div class="aui-flex">
								<div class="aui-flex-box">
									<i class="icon icon-code"></i>
									<input type="number" id="phoneCode" placeholder="验证码" oninput="if(value.length>6) value=value.slice(0,6)" onkeyup="this.value=this.value.replace(/[^0-9]/g,'')"/>
								</div>
								<div class="aui-button-code">
									<button type="button" class="btn btn-default" id="sendVerCode" onclick="sendVerCode1()">获取验证码</button>
								</div>
							</div>
							<!-- <div class="aui-cell-box">
								<label class="cell-right">
									<em>保存即同意《<span style="color:#59E6C4">e达生活协议</span>》</em>
								</label>
							</div> -->
							<div class="aui-ver-button">
								<button type="button" onclick="save()">保存</button>
							</div>
						</div>
					</section>
				</section>
				<input id="id" name="id" type="hidden" value="{$user.id}">
				<input id="token" name="token" type="hidden" value="">
			</form>
		</div>
	</body>
</html>
