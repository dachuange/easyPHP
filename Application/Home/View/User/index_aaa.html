<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>登录/注册</title>
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta content="yes" name="apple-mobile-web-app-capable">
		<meta content="black" name="apple-mobile-web-app-status-bar-style">
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta http-equiv="pragma" content="no-cache">
		<meta http-equiv="cache-control" content="no-cache">
		<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
		<meta http-equiv="Pragma" content="no-cache" />
		<meta http-equiv="Expires" content="0" />
		<link rel="stylesheet" href="__PUBLIC__/home/css/updatephone1.css" media="all">
		<link rel="stylesheet" href="__PUBLIC__/home/css/alert.css" media="all">
		<script type="text/javascript" src="__PUBLIC__/home/js/jquery.min.js"></script>
		<style>
			.disable {
				pointer-events: none;
			}
		</style>
		<script>
			/* function save(){
				alert(123)
			} */
			//发送短信验证码
			//发送短信验证码
			function sendVerCode1() {
				// 禁用点击事件
				$("#sendVerCode").addClass("disable");
				// 提交业务
				//弹框
				var toast = function(params) {
					var el = document.createElement("div");
					el.setAttribute("id", "toast");
					el.innerHTML = params.message;
					document.body.appendChild(el);
					el.classList.add("fadeIn");
					setTimeout(function() {
						el.classList.remove("fadeIn");
						el.classList.add("fadeOut");
						el.addEventListener("animationend", function() {
							el.classList.add("hide");
						});
					}, params.time);
				};
				var phone = $('#phone').val();
				if (phone == "") {
					$("#sendVerCode").removeClass("disable");
					//alert("手机号不能为空");
					toast({
						message: "手机号不能为空",
						time: 1500
					});
					return false;
				}
				if (phone.length != 11) {
					$("#sendVerCode").removeClass("disable");
					toast({
						message: "手机号位数不正确",
						time: 1500
					});
					return false;
				}
				if (!(/^1[34578]\d{9}$/.test(phone))) {
					$("#sendVerCode").removeClass("disable");
					toast({
						message: "手机号码有误，请重填",
						time: 1500
					});
					return false;
				}
			   $.ajax({
					url: '__APP__/User/token', //不跨域调取url
					type: 'post',
					async: 'false',
					success: function(data) {
						console.log('data', data)
						var token = data.token;
						alert(data.token);
						if (phone != "") {
							$.ajax({
								url: '__APP__/User/getyzm',
								type: "POST",
								data: {
									token: token,
									phone: phone
								},
								dataType: "json",
								async: 'false',
								success: function(data) {
									var yzm = data.yzm;
									console.log('yzm', yzm);
									alert(data.error_code)
									/* if (data.error_code == 0) {
										//倒计时
										let count = 60;
										const countDown = setInterval(() => {
											if (count === 0) {
												$("#sendVerCode").removeClass("disable");
												$('#sendVerCode').text('获取验证码').removeAttr('disabled');
												clearInterval(countDown);
											} else {
												$('#sendVerCode').attr('disabled', true);
												$('#sendVerCode').text('重新发送(' + count + ')');
											}
											count--;
										}, 1000);
										toast({
											message: "验证码已下发，请注意查收",
											time: 1500
										});
										return false;
									}
									if (data.error_code == 1) { 
										$("#sendVerCode").removeClass("disable");
										toast({
											message: "号码无效",
											time: 1500
										});
										return false;
									} else if (data.error_code == 2) {
										$("#sendVerCode").removeClass("disable");
										toast({
											message: "该号码达到上限",
											time: 1500
										});
										return false;
									} else if (data.error_code == -501) {
										$("#sendVerCode").removeClass("disable");
										toast({
											message: data.code,
											time: 1500
										});
										return false;
									}*/
								}
							});
						}
						
					},
				}) 
			};
			//保存
						function save() {
							//弹框
							var toast = function(params) {
								var el = document.createElement("div");
								el.setAttribute("id", "toast");
								el.innerHTML = params.message;
								document.body.appendChild(el);
								el.classList.add("fadeIn");
								setTimeout(function() {
									el.classList.remove("fadeIn");
									el.classList.add("fadeOut");
									el.addEventListener("animationend", function() {
										el.classList.add("hide");
									});
								}, params.time);
							};
							var phone = $('#phone').val();
							var openid = $('#openid').val();
							var phoneCode = $('#phoneCode').val();
							var uin_id = $('#uin_id').val();
							var din_id = $('#din_id').val();
							var union_id = $('#union_id').val();
							var yaoCode = $('#yaoCode').val();
							if (phone == "") {
								toast({
									message: "手机号不能为空",
									time: 1500
								});
								return false;
							}
							if (!(/^1[34578]\d{9}$/.test(phone))) {
								toast({
									message: "手机号码有误，请重填",
									time: 1500
								});
								return false;
							}
			// 				if (phoneCode == "") {
			// 					toast({
			// 						message: "验证码不能为空",
			// 						time: 1500
			// 					});
			// 					return false;
			// 				}
							$.ajax({
								url: '__APP__/User/addUser', //不跨域调取url
								type: 'post',
								data: {
									openid: openid,
									phone: phone,
									yzm: phoneCode,
									uin_id: uin_id,
									din_id: din_id,
									unionid: union_id,
									invitcode: yaoCode
								},
								success: function(data) {
									console.log('data', data)
									var code = data.error_code;
									console.log('code', code);
									if (code == 0) {
										// 							toast({
										// 								message: "登录成功，优惠券已发放",
										// 								time: 1100
										// 							});
										// 							setTimeout(function() {
										// 								window.location.href = "__APP__/Index/index/login/1"
										// 							}, 1200);
										window.location.href = "__APP__/Index/index/login/1"
									} else if (code == -401) {
										toast({
											message: "手机号已绑定",
											time: 1500
										});
									} else if (code == -1011) {
										toast({
											message: "验证码不正确",
											time: 1500
										});
									} else if (code == -411) {
										toast({
											message: "微信号已绑定",
											time: 1500
										});
									} else {
										toast({
											message: "手机号绑定失败",
											time: 1500
										});
									}
								}
							});
						}
		</script>
	</head>
	<body>
		<div class="content">
			<form class="resetpassform" id="reset-form">
				<section class="aui-flexView">
					<section class="aui-scrollView">
						<div class="aui-ver-head">
							<img src="__PUBLIC__/home/images/lbj.png" alt="">
						</div>
						<div class="aui-ver-form">
							<div class="aui-flex">
								<div class="aui-flex-box">
									<i class="icon icon-yaocode"></i>
									<input type="tel" maxlength="11" id="phone" placeholder="手机号码" onblur="isPhone();">
								</div>
							</div>
							<div class="aui-flex">
								<div class="aui-flex-box">
									<i class="icon icon-code"></i>
									<input type="number" id="phoneCode" style="cursor:pointer" placeholder="验证码" oninput="if(value.length>6) value=value.slice(0,6)" />
								</div>
								<div class="aui-button-code">
									<button type="button" class="btn btn-default" id="sendVerCode" onclick="sendVerCode1()">获取验证码</button>
								</div>
							</div>
							<div class="aui-flex" id="yaoqing">
								<div class="aui-flex-box">
									<i class="icon icon-yaocode"></i>
									<input type="text" id="yaoCode" maxlength="6" placeholder="邀请码(选填)">
								</div>
							</div>
							<div class="aui-cell-box">
								<label class="cell-right">
									<!-- <input type="checkbox" value="1" name="checkbox" checked="checked">
									<i class="cell-checkbox-icon"></i> -->
									<em>保存即同意《<span style="color:#59E6C4">e达生活协议</span>》</em>
								</label>
							</div>
							<div class="aui-ver-button">
								<button type="button" onclick="save()" style="cursor:pointer">登录/注册</button>
							</div>
						</div>
					</section>
				</section>
				<input id="openid" name="openid" type="hidden" value="{$data.openid}">
				<input id="uin_id" name="uin_id" type="hidden" value="{$data.uin_id}">
				<input id="din_id" name="din_id" type="hidden" value="{$data.din_id}">
				<input id="union_id" name="union_id" type="hidden" value="{$data.unionid}">
				<input id="invit_code" name="invit_code" type="hidden" value="{$data.invit_code}">
				<input id="token" name="token" type="hidden" value="">
			</form>
		</div>
	</body>
</html>
