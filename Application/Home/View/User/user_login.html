<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<title>登录/注册</title>
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta content="yes" name="apple-mobile-web-app-capable">
	<meta content="black" name="apple-mobile-web-app-status-bar-style">
	<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
	<meta http-equiv="pragma" content="no-cache">
	<meta http-equiv="cache-control" content="no-cache">
	<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
	<meta http-equiv="Pragma" content="no-cache" />
	<meta http-equiv="Expires" content="0" />

	<link rel="stylesheet" href="__PUBLIC__/home/css/updatephone1.css" media="all">
	<link rel="stylesheet" href="__PUBLIC__/home/css/login.css" media="all">

	<link rel="stylesheet" href="__PUBLIC__/home/css/alert.css" media="all">
	<style>
		.disable {
			pointer-events: none;
		}
	</style>
	<script type="text/javascript" src="__PUBLIC__/home/js/jquery.min.js"></script>
	<script src="https://res.wx.qq.com/open/js/jweixin-1.2.0.js" type="text/javascript" charset="utf-8"></script>
	<script charset="utf-8" src="https://map.qq.com/api/js?v=2.exp&key=X5JBZ-YS53I-5FFG2-5YZ72-HNS46-CQBBW"></script>
</head>

<body>
	<!-- 微信配置 -->
	<input id="appId" name="appId" type="hidden" value="{$config.appId}">
	<input id="timestamp" name="timestamp" type="hidden" value="{$config.timestamp}">
	<input id="nonceStr" name="nonceStr" type="hidden" value="{$config.nonceStr}">
	<input id="signature" name="signature" type="hidden" value="{$config.signature}">
	<input id="s_local" name="s_local" type="hidden">
	<div class="login-area">
		<div class="logo-area">
			<div class='logo'>
				<img src="__PUBLIC__/home/images/user-logo.png" alt="logo">
			</div>
			<div class='text'>e达出行</div>

		</div>


		<div class="input-area">
			<div class="input-item">
				<div>
					<i class="icon icon-yaocode" style="position:relative;left:0;top:0;"></i>
					<input style="border:none" type="tel" maxlength="11" id="phone" placeholder="手机号码"
						onblur="isPhone();">

				</div>
			</div>
			<div class="input-item">
				<div>
					<i class="icon icon-code" style="position:relative;left:0;top:0;"></i>
					<input type="number" id="phoneCode" style="cursor:pointer;"
						oninput="if(value.length>6) value=value.slice(0,6)" style="border:none" type="text"
						placeholder="验证码">

				</div>
				<div type="button"  class="btn btn-default" id="sendVerCode" onclick="sendVerCode1()">获取验证码</div>
			</div>


		</div>


		<div class="content">
			<form class="resetpassform" id="reset-form" style="height:85%;">
				<section class="aui-flexView">
					<section class="aui-scrollView">





						<div class="aui-ver-form">
							<!-- <div class="aui-flex">
							<div class="aui-flex-box">
								<i class="icon icon-yaocode"></i>
								<input type="tel" maxlength="11" id="phone" placeholder="手机号码" onblur="isPhone();">
							</div>
						</div> -->
							<!-- <div class="aui-flex">
								<div class="aui-flex-box">
									<i class="icon icon-code"></i>
									<input type="number" id="phoneCode" style="cursor:pointer" placeholder="验证码"
										oninput="if(value.length>6) value=value.slice(0,6)" />
								</div>
								<div class="aui-button-code">
									<button type="button" class="btn btn-default" id="sendVerCode"
										onclick="sendVerCode1()">获取验证码</button>
								</div>
							</div> -->
							<div class="aui-flex" id="yaoqing">
								<div class="aui-flex-box">
									<i class="icon icon-yaocode"></i>
									<input type="text" id="yaoCode" maxlength="6" placeholder="邀请码(选填)">
								</div>
							</div>
							<div class="aui-cell-box">
								<label class="cell-right">
									<!-- <input type="checkbox" value="1" name="checkbox" checked="checked">
									<i class="cell-checkbox-icon"></i> -->
									<em>保存即同意<a href="__APP__/Index/user_protocol">《<span
												style="color:#59E6C4">e达生活协议</span>》</a></em>
								</label>
							</div>
							<div class="aui-ver-button">
								<button type="button" onclick="save()" style="cursor:pointer">登录/注册</button>
							</div>
						</div>
					</section>
				</section>
				<input id="openid" name="openid" type="hidden" value="{$data.openid}">
				<input id="uin_id" name="uin_id" type="hidden" value="{$data.uin_id}">
				<input id="din_id" name="din_id" type="hidden" value="{$data.din_id}">
				<input id="union_id" name="union_id" type="hidden" value="{$data.unionid}">
				<!-- <input id="invit_code" name="invit_code" type="hidden" value="{$data.invit_code}"> -->
				<input id="token" name="token" type="hidden" value="">
			</form>
			<!-- <div style="text-align: center;font-size: 0.9rem;">
				<p>Copyright © 2019 e达生活. All rights reserved.</p>
				<a href="https://www.beianx.cn/info/6dc59918eac540dc98ab4d62db8683ac.html">津ICP备19003809号</a>
			</div> -->
		</div>
</body>
<script>
	/* 微信配置 */
	var appId = $('#appId').val();
	var timestamp = $('#timestamp').val();
	var nonceStr = $('#nonceStr').val();
	var signature = $('#signature').val();
	wx.config({
		debug: false, //调试模式   当为tru时，开启调试模式 
		appId: appId,
		timestamp: timestamp.toString(), //签名时间戳
		nonceStr: nonceStr, //生成签名的随机串 
		signature: signature, //签名                    
		jsApiList: ['openLocation', 'getLocation'],
		success: function (res) {
			if (res.checkResult.getLocation == false) {
				alert('你的微信版本太低，不支持微信JS接口，请升级到最新的微信版本！');
				return;
			}
			alert("配置成功")
		},
		fail: function () {
			alert("配置失败")
		}
	});
	wx.ready(function () {
		wx.getLocation({
			type: "gcj02",
			success: function (res) {
				console.log(res)
				latitude = res.latitude;
				longitude = res.longitude;
				//alert(latitude + "," + longitude);
				geocoder(latitude, longitude);
				geosend(latitude, longitude);
			},
			cancel: function (res) {
				alert('用户拒绝授权获取地理位置'); //用户拒绝授权
			},
		});
	});
	//将经纬度解析为详细的地址
	function geocoder(latitude, longitude) {
		var ll = latitude + "," + longitude;
		$.ajax({
			type: 'get',
			url: 'https://apis.map.qq.com/ws/geocoder/v1',
			dataType: 'jsonp',
			data: {
				key: "X5JBZ-YS53I-5FFG2-5YZ72-HNS46-CQBBW", //开发密钥
				location: ll,
				//位置坐标
				get_poi: "0", //是否返回周边POI列表：1.返回；0不返回(默认)
				//coord_type: "5", //输入的locations的坐标类型,1 火星坐标
				parameter: {
					"scene_type": "tohome",
					"poi_num": 20
				}, //附加控制功能
				output: "jsonp"
			},
			success: function (data, textStatus) {
				console.log("data", data)
				var formatted_addresses = data.result.formatted_addresses;
				console.log("formatted_addresses", formatted_addresses);
				var recommend = formatted_addresses.recommend;
				console.log("recommend", recommend);
				if (data.status == 0) {
					var address = data.result.address;
					//$('#s_local').val(address);//显示街道
					$('#s_local').val(recommend); //显示名称
				} else {
					alert("系统错误，请联系管理员！")
				}
			},
			error: function () {
				alert("系统错误，请联系管理员！")
			}
		});
	}
	//将用户位置传给后台
	function geosend(latitude, longitude) {
		//弹框
		var toast = function (params) {
			var el = document.createElement("div");
			el.setAttribute("id", "toast");
			el.innerHTML = params.message;
			document.body.appendChild(el);
			el.classList.add("fadeIn");
			setTimeout(function () {
				el.classList.remove("fadeIn");
				el.classList.add("fadeOut");
				el.addEventListener("animationend", function () {
					el.classList.add("hide");
				});
			}, params.time);
		};
		var lat = latitude;
		var lng = longitude;
		var unionid = $('#union_id').val();
		$.ajax({
			url: '__APP__/User/user_addressid_add', //不跨域调取url
			type: 'post',
			data: {
				lat: lat,
				lng: lng,
				unionid: unionid
			},
			success: function (data) {
				console.log('data', data)
				var code = data.error_code;
				if (code == -1) {
					toast({
						message: data.message,
						time: 1500
					});
				}
			}
		});
	}
</script>
<script type="text/javascript">
	//手机号校验
	function isPhone() {
		//弹框
		var toast = function (params) {
			var el = document.createElement("div");
			el.setAttribute("id", "toast");
			el.innerHTML = params.message;
			document.body.appendChild(el);
			el.classList.add("fadeIn");
			setTimeout(function () {
				el.classList.remove("fadeIn");
				el.classList.add("fadeOut");
				el.addEventListener("animationend", function () {
					el.classList.add("hide");
				});
			}, params.time);
		};
		var phone = $('#phone').val();
		if (phone == "") {
			toast({
				message: "手机号不能为空",
				time: 1500
			});
			return false;
		}
		if (phone.length != 11) {
			toast({
				message: "手机号位数不正确",
				time: 1500
			});
			return false;
		}
		var myreg = /^[1](([3][0-9])|([4][5-9])|([5][0-3,5-9])|([6][5,6])|([7][0-8])|([8][0-9])|([9][1,8,9]))[0-9]{8}$/;
		if (!(myreg.test(phone))) {
			toast({
				message: "手机号码有误，请重填",
				time: 1500
			});
			return false;
		}
	}
	//发送短信验证码
	function sendVerCode1() {
		// 禁用点击事件
		$("#sendVerCode").addClass("disable");
		// 提交业务
		//弹框
		var toast = function (params) {
			var el = document.createElement("div");
			el.setAttribute("id", "toast");
			el.innerHTML = params.message;
			document.body.appendChild(el);
			el.classList.add("fadeIn");
			setTimeout(function () {
				el.classList.remove("fadeIn");
				el.classList.add("fadeOut");
				el.addEventListener("animationend", function () {
					el.classList.add("hide");
				});
			}, params.time);
		};
		var phone = $('#phone').val();
		if (phone == "") {
			$("#sendVerCode").removeClass("disable");
			//alert("手机号不能为空");
			toast({
				message: "手机号不能为空",
				time: 1500
			});
			return false;
		}
		if (phone.length != 11) {
			$("#sendVerCode").removeClass("disable");
			toast({
				message: "手机号位数不正确",
				time: 1500
			});
			return false;
		}
		var myreg = /^[1](([3][0-9])|([4][5-9])|([5][0-3,5-9])|([6][5,6])|([7][0-8])|([8][0-9])|([9][1,8,9]))[0-9]{8}$/;
		if (!(myreg.test(phone))) {
			$("#sendVerCode").removeClass("disable");
			toast({
				message: "手机号码有误，请重填",
				time: 1500
			});
			return false;
		}
		$.ajax({
			//url:' http://39.98.43.249/User/token',//跨域调取URL
			url: '__APP__/User/token', //不跨域调取url
			type: 'post',
			//data:'id='+id,
			success: function (data) {
				console.log('data', data)
				var token = data.token;
				$('#token').val(token);
				//获取验证码
				if (phone != "") {
					$.ajax({
						url: '__APP__/User/getyzm',
						type: "POST",
						data: {
							token: token,
							phone: phone
						},
						dataType: "json",
						async: 'false',
						success: function (data) {
							var yzm = data.yzm;
							console.log('yzm', yzm);
							if (data.error_code == 0) {
								//倒计时
								let count = 60;
								const countDown = setInterval(() => {
									if (count === 0) {
										$("#sendVerCode").removeClass("disable");
										$('#sendVerCode').text('获取验证码').removeAttr('disabled');
										clearInterval(countDown);
									} else {
										$('#sendVerCode').attr('disabled', true);
										$('#sendVerCode').text('重新发送(' + count + ')');
									}
									count--;
								}, 1000);
								toast({
									message: "验证码已下发，请注意查收",
									time: 1500
								});
								return false;
							}
							if (data.error_code == 1) {
								$("#sendVerCode").removeClass("disable");
								toast({
									message: "号码无效",
									time: 1500
								});
								return false;
							} else if (data.error_code == 2) {
								$("#sendVerCode").removeClass("disable");
								toast({
									message: "该号码达到上限",
									time: 1500
								});
								return false;
							} else if (data.error_code == -501) {
								$("#sendVerCode").removeClass("disable");
								toast({
									message: data.code,
									time: 1500
								});
								return false;
							}
						}
					});
				}
			},
			error: function () {
				$("#sendVerCode").removeClass("disable");
				toast({
					message: "网络异常，请稍后再试",
					time: 1500
				});
			}
		})
	};
	//保存
	function save() {
		//弹框
		var toast = function (params) {
			var el = document.createElement("div");
			el.setAttribute("id", "toast");
			el.innerHTML = params.message;
			document.body.appendChild(el);
			el.classList.add("fadeIn");
			setTimeout(function () {
				el.classList.remove("fadeIn");
				el.classList.add("fadeOut");
				el.addEventListener("animationend", function () {
					el.classList.add("hide");
				});
			}, params.time);
		};
		var phone = $('#phone').val();
		var openid = $('#openid').val();
		var phoneCode = $('#phoneCode').val();
		var uin_id = $('#uin_id').val();
		var din_id = $('#din_id').val();
		var union_id = $('#union_id').val();
		var yaoCode = $('#yaoCode').val();
		if (phone == "") {
			toast({
				message: "手机号不能为空",
				time: 1500
			});
			return false;
		}
		var myreg = /^[1](([3][0-9])|([4][5-9])|([5][0-3,5-9])|([6][5,6])|([7][0-8])|([8][0-9])|([9][1,8,9]))[0-9]{8}$/;
		if (!(myreg.test(phone))) {
			toast({
				message: "手机号码有误，请重填",
				time: 1500
			});
			return false;
		}
		if (phoneCode == "") {
			toast({
				message: "验证码不能为空",
				time: 1500
			});
			return false;
		}
		$.ajax({
			url: '__APP__/User/addUser', //不跨域调取url
			type: 'post',
			data: {
				openid: openid,
				phone: phone,
				yzm: phoneCode,
				uin_id: uin_id,
				din_id: din_id,
				unionid: union_id,
				invitcode: yaoCode
			},
			success: function (data) {
				console.log('data', data)
				var code = data.error_code;
				console.log('code', code);
				if (code == 0) {
					// 							toast({
					// 								message: "登录成功，优惠券已发放",
					// 								time: 1100
					// 							});
					// 							setTimeout(function() {
					// 								window.location.href = "__APP__/Index/index/login/1"
					// 							}, 1200);
					window.location.href = "__APP__/Index/index/login/1"
				} else if (code == -401) {
					toast({
						message: "手机号已绑定",
						time: 1500
					});
				} else if (code == -1011) {
					toast({
						message: "验证码不正确",
						time: 1500
					});
				} else if (code == -411) {
					toast({
						message: "微信号已绑定",
						time: 1500
					});
				} else {
					toast({
						message: "手机号绑定失败",
						time: 1500
					});
				}
			},
			error: function (jqXHR, textStatus, errorThrown) {
				toast({
					message: "当前网络异常，请稍后再试",
					time: 1500
				});
			}
		});
	}
	//获取token
	function time() {
		$.ajax({
			//url:' http://39.98.43.249/User/token',//跨域调取URL
			url: '__APP__/User/token', //不跨域调取url
			type: 'post',
			//data:'id='+id,
			success: function (data) {
				console.log('data', data)
				var token = data.token;
				console.log('token', token)
				$('#token').val(token);
			}
		});
	}
	//每隔7200执行一次
	$(function () {
		//time();
		//setInterval(time, 7200);
	})
</script>
<script>
	var invit_code = "{$data.invit_code}";
	if (invit_code == 'Y') {
		$('#yaoqing').show();
	} else {
		$('#yaoqing').hide();
	}
</script>
<script type="text/javascript">
	//弹框
	var toast = function (params) {
		var el = document.createElement("div");
		el.setAttribute("id", "toast");
		el.innerHTML = params.message;
		document.body.appendChild(el);
		el.classList.add("fadeIn");
		setTimeout(function () {
			el.classList.remove("fadeIn");
			el.classList.add("fadeOut");
			el.addEventListener("animationend", function () {
				el.classList.add("hide");
			});
		}, params.time);
	};
	var str = navigator.userAgent.toLowerCase();
	var ver = str.match(/cpu iphone os (.*?) like mac os/);
	if (!ver) {
		//alert("请在Ios系统中打开");
	} else {
		//alert("你当前的Ios系统版本为：" + ver[1].replace(/_/g, "."));
		var version = ver[1].replace(/_/g, ".");
		if (version < "10.0.0") {
			//alert("请您更新系统版本")
			toast({
				message: "您当前版本过低，请您更新系统",
				time: 2500
			});
		} else {
			//alert("可以打车")
		}
	}
</script>

</html>