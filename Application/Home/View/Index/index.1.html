<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<title>车辆位置</title>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta content="yes" name="apple-mobile-web-app-capable">
		<meta content="black" name="apple-mobile-web-app-status-bar-style">
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta http-equiv="pragma" content="no-cache">
		<meta http-equiv="cache-control" content="no-cache">
		<meta http-equiv="Expires" content="0" />
		<link rel="stylesheet" href="__PUBLIC__/home/css/index.css" media="all">
		<!-- <script src="https://res.wx.qq.com/open/js/jweixin-1.4.0.js" type="text/javascript" charset="utf-8"></script> -->
		<script type="text/javascript" src="__PUBLIC__/home/js/jquery.min.js"></script>
		<script type="text/javascript" src="https://3gimg.qq.com/lightmap/components/geolocation/geolocation.min.js"></script>
		<script charset="utf-8" src="https://map.qq.com/api/js?v=2.exp&key=X5JBZ-YS53I-5FFG2-5YZ72-HNS46-CQBBW"></script>
		<style type="text/css">
			* {
				margin: 0px;
				padding: 0px;
			}

			body {
				background: #f4f5f6;
				background-size: cover;
				overflow-x: hidden;
				overflow-y: hidden;
				font-family: 'Microsoft YaHei';
			}

			#container {
				width: 100%;
				min-height: 750px;
			}

			#up-map-div {
				width: 100%;
				height: 60px;
				position: absolute;
				z-index: 9999;
				bottom: 0;
			}
		</style>
		<script>
			$(function() {
				//内测的版本
				var check=$('#check').val();
				if(check=="Y"){
				}else{
					$('#lalala').hide();
					$('#con').html('系统正在内测，7.18号正式上线，敬请期待！')
				}
				geolocation.watchPosition(showPosition, showErr, options);
			})
			//当前定位
			var geolocation = new qq.maps.Geolocation("X5JBZ-YS53I-5FFG2-5YZ72-HNS46-CQBBW", "myapp");
			var positionNum = 0;
			var options = {
				timeout: 8000
			};
			function showPosition(position) {
				var adCode = position.adCode; //邮政编码
				var nation = position.nation; //中国
				var city = position.city; //城市
				var addr = position.addr; //详细地址
				var lat = position.lat; //
				var lng = position.lng; //火星坐标 //TODO 实现业务代码逻辑 
				$('#s_lat').val(lat);
				$('#s_lng').val(lng);
				if(lat!='' && lng!=''){
					init()
				}
			};
			function showErr() {
				//TODO 如果出错了调用此方法 
			};
			function init() {
				var s_lat=$('#s_lat').val();
				var s_lng=$('#s_lng').val();
				var center = new qq.maps.LatLng(s_lat,s_lng);
				var map = new qq.maps.Map(document.getElementById("container"), {
					center: center,
					zoom: 15
				});
				//添加监听事件   获取鼠标单击事件
				qq.maps.event.addListener(map, 'click', function(event) {
				   var marker=new qq.maps.Marker({
							position:event.latLng, 
							map:map
					  });    
				  qq.maps.event.addListener(map, 'click', function(event) {
						marker.setMap(null);      
					});
					var result=event.latLng
					console.log("result",result)
					var lng=result.lng;
					console.log("lng",lng)
					var lat=result.lat;
					console.log("lat",lat)
						if(lat!='' && lng!=''){
						$.ajax({
							url: '__APP__/Message/dviver_onsite',
							type: "POST",
							data: {
								lat: lat,
								lng: lng,
								limit:'3000'
							},
							dataType: "json",
							success: function(data) {
								console.log(data)
								if(data.error_code==0){
									var obj = eval(data.list);  
									console.log('obj1',obj)
									for(var i in obj){
									   var latlngs = [new qq.maps.LatLng(obj[i].lat,obj[i].lng)];
									   for (var i = 0; i < latlngs.length; i++) {
												(function(n) {
													var end_icon = new qq.maps.MarkerImage(
														'__PUBLIC__/home/images/car3.png',
													);
													var marker = new qq.maps.Marker({
														icon: end_icon,
														position: latlngs[n],
														map: map
													});
													/* qq.maps.event.addListener(marker, 'click', function() {
														infoWin.open();
														infoWin.setContent('<div style="text-align:center;white-space:' +
															'nowrap;margin:10px;">这是第 ' +
															n + ' 个标注</div>');
														infoWin.setPosition(latlngs[n]);
													}); */
												})(i);
										}
									}
								}else{
										//layer.open({ content: "获取附近商铺失败", skin: 'msg', time: 2 });
								}
							},
						})
					}
				});
				//设置marker标记
				var marker = new qq.maps.Marker({
					icon:'__PUBLIC__/home/images/loc1.png',
					map: map,
					position: center
				});
				var infoWin = new qq.maps.InfoWindow({
					map: map
				});
				if(s_lat!='' && s_lng!=''){
					$.ajax({
						url: '__APP__/Message/dviver_onsite',
						type: "POST",
						data: {
							lat: s_lat,
							lng: s_lng,
							limit:'3000'
						},
						dataType: "json",
						success: function(data) {
							console.log(data)
							if(data.error_code==0){
								var obj = eval(data.list);  
								console.log('obj',obj)
								for(var i in obj){
								   var latlngs = [new qq.maps.LatLng(obj[i].lat,obj[i].lng)];
								   for (var i = 0; i < latlngs.length; i++) {
											(function(n) {
												var end_icon = new qq.maps.MarkerImage(
													'__PUBLIC__/home/images/car3.png',
												);
												var marker = new qq.maps.Marker({
													icon: end_icon,
													position: latlngs[n],
													map: map
												});
												/* qq.maps.event.addListener(marker, 'click', function() {
													infoWin.open();
													infoWin.setContent('<div style="text-align:center;white-space:' +
														'nowrap;margin:10px;">这是第 ' +
														n + ' 个标注</div>');
													infoWin.setPosition(latlngs[n]);
												}); */
											})(i);
									}
								}
							}else{
									//layer.open({ content: "获取附近商铺失败", skin: 'msg', time: 2 });
							}
						},
					})
				}
			}
		</script>
	</head>
	<body onload="init()" id="con">
		<div id="lalala">
			<input id="s_lat" name="s_lat" type="hidden" value="">
			<input id="s_lng" name="s_lng" type="hidden" value="">
			<input id="check" name="check" type="hidden" value="{$check}">
			<div style="width:100%;height: 750px;" id="container"></div>
			<div id="up-map-div">
				<include file="Public:footer" />
			</div>
			<!--红包 遮罩 -->
			<div class="zhezhao" id="zhezhao">
				<div class="beijing">
					<div class="close" onclick="zhezhao()">
						<img src="__PUBLIC__/home/images/close.png" class="guanbi" />
					</div>
					<div class="jine">
						¥{$login.amount}
					</div>
					<div class="btn" onclick="fenxiang()">
						<img src="__PUBLIC__/home/images/fenxiang.png" class="anniu" />
					</div>
				</div>
			</div>
			<input id="login" name="login" type="hidden" value="{$login.login}">
		</div>
	</body>
	<script>
		var browserRule = /^.*((iPhone)|(iPad)|(Safari))+.*$/;
		if (browserRule.test(navigator.userAgent)) {
			window.onpageshow = function(event) {
				if (event.persisted) {
					window.location.reload()
				}
			};
		}
	</script>
	<script type="text/javascript">
		var login = $('#login').val(); //判断是否显示遮罩层
		if (login == 1) {
			$('#zhezhao').show();
			$('#container').hide();
		} else {
			$('#zhezhao').hide();
			$('#container').show();
		}

		function zhezhao() {
			$('#zhezhao').hide();
			$('#container').show();
		}

		function fenxiang() {
			window.location.href = "__APP__/Index/invite_user_check"
		}
	</script>
</html>
