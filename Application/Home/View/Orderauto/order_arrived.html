<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta content="yes" name="apple-mobile-web-app-capable">
		<meta content="black" name="apple-mobile-web-app-status-bar-style">
		<meta name="format-detection" content="telephone=yes"/>
		<meta http-equiv="pragma" content="no-cache">
		<meta http-equiv="cache-control" content="no-cache">
		<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
		<meta http-equiv="Pragma" content="no-cache" />
		<meta http-equiv="Expires" content="0" />
		<link rel="stylesheet" href="__PUBLIC__/home/css/wait.css" media="all">
		<script type="text/javascript" src="__PUBLIC__/home/js/jquery.min.js"></script>
		<title>司机已到达</title>
		<style type="text/css">
			* {
				margin: 0px;
				padding: 0px;
			}

			body,
			button,
			input,
			select,
			textarea {
				font: 12px/16px Verdana, Helvetica, Arial, sans-serif;
			}

			#container {
				width: 100%;
				height: 100%;
			}

			#up-map-div {
				width: 100%;
				height: 50px;
				position: fixed;
				z-index: 9999;
				bottom: 5%;
			}
		</style>
		<script charset="utf-8" src="https://map.qq.com/api/js?v=2.exp&key=X5JBZ-YS53I-5FFG2-5YZ72-HNS46-CQBBW"></script>
		<script>
			var map, 
      directionsService = new qq.maps.DrivingService({
          complete : function(response){
              var start = response.detail.start,
                  end = response.detail.end;
                  start_icon = new qq.maps.MarkerImage(
                    '__PUBLIC__/home/images/car1.png', 
//                       new qq.maps.Size(40, 60),
//                       new qq.maps.Point(0, 0),
                  ),
                  end_icon = new qq.maps.MarkerImage(
					 '__PUBLIC__/home/images/loc1.png', 
// 				      new qq.maps.Size(35, 55),
//                       new qq.maps.Point(0, 0),
                  );
              start_marker && start_marker.setMap(null); 
              end_marker && end_marker.setMap(null);
              clearOverlay(route_lines);
                start_marker = new qq.maps.Marker({
                      icon: end_icon,
                      position: start.latLng,
                      map: map,
                      //zIndex:1
                });
                end_marker = new qq.maps.Marker({
					  icon: start_icon,
                      position: end.latLng,
                      map: map,
                      //zIndex:1
                });
               directions_routes = response.detail.routes;
               var routes_desc=[];
               //所有可选路线方案
               for(var i = 0;i < directions_routes.length; i++){
                    var route = directions_routes[i],
                        legs = route; 
                    //调整地图窗口显示所有路线    
                    map.fitBounds(response.detail.bounds); 
                        var steps = legs.steps;
                        route_steps = steps;
                        polyline = new qq.maps.Polyline(
                            {
                                path: route.path,
                                strokeColor: '#3893F9',
                                strokeWeight: 6,
                                map: map
                            }
                        )  
                        route_lines.push(polyline);
               }
               //方案文本描述
               var routes=document.getElementById('routes');
               routes.innerHTML = routes_desc.join('<br>');
            }
        }),
        directions_routes,
        directions_placemarks = [],
        directions_labels = [],
        start_marker,
        end_marker,
        route_lines = [],
        step_line,
        route_steps = [];

    function init() {
        map = new qq.maps.Map(document.getElementById("container"), {
        // 地图的中心地理坐标。
        center: new qq.maps.LatLng(39.083172,117.199402),
        zoom: 15,
        });
        calcRoute();
    }
    function calcRoute() {
       var userweidu=$('#userweidu').val();
       var userjingdu=$('#userjingdu').val();
       var sijiweidu=$('#sijiweidu').val();
       var sijijingdu=$('#sijijingdu').val();
	   var policy ='LEAST_TIME';
	   route_steps = [];
       directionsService.setLocation("天津");
	   directionsService.setPolicy(qq.maps.DrivingPolicy[policy]);
       directionsService.search(new qq.maps.LatLng(userweidu, userjingdu),//中心点
	   new qq.maps.LatLng(sijiweidu, sijijingdu));
    }
    //清除地图上的marker
    function clearOverlay(overlays){
        var overlay;
        while(overlay = overlays.pop()){
            overlay.setMap(null);
        }
    }
    function renderStep(index){   
        var step = route_steps[index];
        //clear overlays;
        step_line && step_line.setMap(null);
        //draw setp line      
        step_line = new qq.maps.Polyline(
            {
                path: step.path,
                strokeColor: '#ff0000',
                strokeWeight: 6,
                map: map
            }
        )
    }
    //显示路段路标
    function showP(){
        var showPlacemark  = document.getElementById('sp');
        if(showPlacemark.checked){
            for(var i=0;i<directions_placemarks.length;i++){
                var placemarks = directions_placemarks[i];
                for(var j=0;j<placemarks.length;j++){
                    var placemark = placemarks[j];
                    var label = new qq.maps.Label({
                        map: map,
                        position: placemark.latLng,
                        content:placemark.name
                    });
                    directions_labels.push(label);
                }
            }
        }else{
            clearOverlay(directions_labels);
        }
    } 
    //获取司机位置
	function driver(){
	var o_id = $('#o_id').val();
	var d_id = $('#d_id').val();
	$.ajax({
		url: '__APP__/Orderauto/drive_dynamic',
		type: "POST",
		  data: {
			drive_id: d_id,
			orderid: o_id
		  },
		  dataType: "json",
		  async:'false', 
		  success: function(data) {
			console.log('data',data);
			var driverLatitude = data.latitude;
			var driverLongitude = data.longitude;
			$('#sijiweidu').val(driverLatitude);
			$('#sijijingdu').val(driverLongitude);
			 calcRoute();//重新画地图
			var psd = data.psd;
			console.log('psd',psd)
			var total = data.total;
		    if (psd == 'arrived') {
				
		    }else if (psd == 'active') {
		    	window.location.href ="__ROOT__/Orderauto/order_active?o_id="+o_id
		    }else if (psd == 'wait_pay') {
		    	window.location.href ="__ROOT__/Orderauto/order_deatil?o_id="+o_id
		    }
			setTimeout(driver,4000); 
		  }
		})
	}
	//取消订单
	function cancel(){
		var o_id = $('#o_id').val();
		window.location.href ="__APP__/Orderauto/canecl_order?o_id="+o_id
	}
	//每隔3000执行一次
	$(function() {
		init();//重新画地图
		setTimeout(driver,3000); 
	})
</script>
	</head>
	<body>
		<div class="total1" style="margin-top:5px;">
			<div class="total-driver">
				<div class="driver-info">
					<if condition="$order['avatar']  neq '' ">
						<div class="driver-img">
							<image style="width: 75px;height: 75px;border-radius: 50%;" src="{$order.avatar}" />
						</div>
						<else />
						<div class="driver-img">
							<image style="width: 75px;height: 75px;border-radius: 50%;" src="__PUBLIC__/home/images/driver.png" />
						</div>
					</if>
					<div class="driver-detailed">
						<div class="detailed-name">{$order.nickname}
							<img class="star" style="width: 12px;height: 12px;display: inline-block;" src="__PUBLIC__/home/images/star.png"></img>
							<div class="orderTotal">{$order.point}</div>
							<div class="orderTotal1">{$order.lits}单</div>
						</div>
						<div class="detailed-Cartnumber">{$order.carnum}</div>
						<div class="detailed-cart">{$order.carcolor}-{$order.car_type}</div>
					</div>
				</div>
				<div class="driver-message">
					<!-- <a href="sms:{$order.d_phone}">
						<div class="mas">
							<image style="width: 35px;height: 35px;" src="__PUBLIC__/home/images/msm.png" />
						</div>
					</a> -->
					<a href="tel:{$order.d_phone}">
						<div class="phone">
							<image style="width: 35px;height: 35px;" src="__PUBLIC__/home/images/phone.png" />
						</div>
					</a>
				</div>
			</div>
		  <!-- 司机位置-->
			<div class="driverlocal1">司机已到达</div>
		</div>
		<!-- end#### -->
		<div style="height:820px">
			<div id="container"></div>
		</div>
		<div id="up-map-div">
			<div class="zong">
				<div class="zuo">
					<a href="tel:110">
						<button class="wode_out1">一键报警</button>
					</a>
				</div>
				<div class="you">
					<button class="wode_out" onclick="cancel()" id="zhifu">取消订单</button>
				</div>
			</div>
		</div>
		<div id="routes"></div>
		<input id="sijijingdu" name="sijijingdu" type="hidden" value="{$order.e_lng}" onchange="calcRoute();">
		<input id="userweidu" name="userweidu" type="hidden" value="{$order.s_lat}" onchange="calcRoute();">
		<input id="userjingdu" name="userjingdu" type="hidden" value="{$order.s_lng}" onchange="calcRoute();">
		<input id="sijiweidu" name="sijiweidu" type="hidden" value="{$order.e_lat}" onchange="calcRoute();">
		<input id="d_id" name="d_id" type="hidden" value="{$order.d_id}">
		<input id="o_id" name="o_id" type="hidden" value="{$order.o_id}">
		<input id="timer" name="timer" type="hidden" value="">
		<input id="timer1" name="timer1" type="hidden" value="">
	</body>
</html>
